<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timer Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* ... styles unchanged ... */
  </style>
</head>
<body>
  <h1><i class="fa-solid fa-stopwatch"></i> One Rounds Timer</h1>
  <div class="widget-grid" id="timers"></div>
  <script>
    const TIMER_COUNT = 5;
    const billiardNames = [
      'Billiard 1',
      'Billiard 2',
      'Billiard 3',
      'Billiard 4',
      'Billiard 5'
    ];
    let timers = Array.from({length: TIMER_COUNT}, (_, i) => ({
      id: i,
      name: billiardNames[i],
      state: "stopped",
      startTime: null,
      elapsed: 0,
      pauseTime: null,
      date: '', // blank on load
      time: '' // blank on load
    }));

    const timerRefs = {};

    function formatDuration(ms) {
      const sec = Math.floor(ms/1000)%60;
      const min = Math.floor(ms/60000)%60;
      const hr = Math.floor(ms/3600000);
      return `${hr.toString().padStart(2,"0")}:${min.toString().padStart(2,"0")}:${sec.toString().padStart(2,"0")}`;
    }

    function renderTimers() {
      const grid = document.getElementById('timers');
      grid.innerHTML = '';
      timers.forEach(timer => {
        const widget = document.createElement('div');
        widget.className = 'timer-widget';
        widget.id = `widget-${timer.id}`;

        // Name row
        const nameRow = document.createElement('div');
        nameRow.className = 'timer-name-row';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'timer-name';
        nameSpan.textContent = timer.name;
        nameSpan.setAttribute('data-id', timer.id);
        nameRow.appendChild(nameSpan);

        // Controls
        const controls = document.createElement('div');
        controls.className = 'timer-controls';

        const startBtn = document.createElement('button');
        startBtn.innerHTML = `<i class="fa-solid fa-play"></i>`;
        startBtn.title = timer.state === 'stopped' ? 'Start' : 'Restart';
        startBtn.disabled = (timer.state === 'running');
        startBtn.onclick = () => updateTimerState(timer.id, 'start');

        const pauseBtn = document.createElement('button');
        pauseBtn.innerHTML = timer.state === 'paused'
          ? '<i class="fa-solid fa-play"></i>'
          : '<i class="fa-solid fa-pause"></i>';
        pauseBtn.title = timer.state === 'paused' ? 'Resume' : 'Pause';
        pauseBtn.disabled = (timer.state!=='running' && timer.state!=='paused');
        pauseBtn.onclick = () => updateTimerState(timer.id, 'pause');

        const stopBtn = document.createElement('button');
        stopBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
        stopBtn.title = 'Stop/Reset';
        stopBtn.disabled = (timer.state === 'stopped');
        stopBtn.onclick = () => updateTimerState(timer.id, 'stop');

        controls.appendChild(startBtn);
        controls.appendChild(pauseBtn);
        controls.appendChild(stopBtn);

        // Status dot
        const dot = document.createElement('span');
        dot.className = 'timer-status-dot dot-' + timer.state;
        dot.id = `dot-${timer.id}`;

        // Timer details
        const details = document.createElement('div');
        details.className = 'timer-details';
        details.innerHTML = `
          <span id="status-${timer.id}">${dot.outerHTML}<strong>Status:</strong> ${timer.state[0].toUpperCase()+timer.state.slice(1)}</span>
          <span>
            <strong>Date:</strong>
            <input type="date" id="date-${timer.id}" value="${timer.date}" style="font-size: 1em; padding: 2px 10px; border-radius: 6px; border: 1px solid #FFD700;">
          </span>
          <span>
            <strong>Time:</strong>
            <input type="time" id="time-${timer.id}" value="${timer.time}" style="font-size: 1em; padding: 2px 10px; border-radius: 6px; border: 1px solid #FFD700;">
          </span>
          <span><strong>Start:</strong> <span id="start-${timer.id}">${timer.startTime ? new Date(timer.startTime).toLocaleTimeString() : '--:--:--'}</span></span>
          <span><strong>Elapsed:</strong> <span class="elapsed" id="elapsed-${timer.id}">${formatDuration(timer.elapsed)}</span></span>
        `;

        widget.appendChild(nameRow);
        widget.appendChild(controls);
        widget.appendChild(details);

        grid.appendChild(widget);

        timerRefs[timer.id] = {
          widget,
          nameSpan,
          startBtn,
          pauseBtn,
          stopBtn,
          dot: widget.querySelector(`#dot-${timer.id}`),
          status: widget.querySelector(`#status-${timer.id}`),
          start: widget.querySelector(`#start-${timer.id}`),
          elapsed: widget.querySelector(`#elapsed-${timer.id}`),
          dateInput: widget.querySelector(`#date-${timer.id}`),
          timeInput: widget.querySelector(`#time-${timer.id}`)
        };

        // Editable date/time
        timerRefs[timer.id].dateInput.addEventListener('change', (e) => {
          timers[timer.id].date = e.target.value;
        });
        timerRefs[timer.id].timeInput.addEventListener('change', (e) => {
          timers[timer.id].time = e.target.value;
        });
      });
    }

    function updateTimerState(id, action) {
      const timer = timers[id];
      let changed = false;
      if (action === 'start') {
        timer.state = 'running';
        // Use current date/time if blank
        let now = new Date();
        let chosenDate = timer.date && timer.date.trim() !== '' ? timer.date : now.toISOString().split('T')[0];
        let chosenTime = timer.time && timer.time.trim() !== '' ? timer.time : now.toTimeString().slice(0,8);
        let startDateTime = new Date(`${chosenDate}T${chosenTime}`);
        if (!isNaN(startDateTime.getTime())) {
          timer.startTime = startDateTime.getTime();
        } else {
          timer.startTime = Date.now();
        }
        timer.elapsed = 0;
        timer.pauseTime = null;
        changed = true;
      } else if (action === 'pause') {
        if (timer.state === 'running') {
          timer.state = 'paused';
          timer.pauseTime = Date.now();
          changed = true;
        } else if (timer.state === 'paused') {
          timer.state = 'running';
          if (timer.pauseTime) timer.startTime += (Date.now() - timer.pauseTime);
          timer.pauseTime = null;
          changed = true;
        }
      } else if (action === 'stop') {
        timer.state = 'stopped';
        timer.startTime = null;
        timer.elapsed = 0;
        timer.pauseTime = null;
        timer.date = ''; // blank on reset
        timer.time = ''; // blank on reset
        changed = true;
      }
      if (changed) updateWidgetDOM(id);
    }

    function updateWidgetDOM(id) {
      const t = timers[id];
      const ref = timerRefs[id];
      ref.startBtn.title = t.state === 'stopped' ? 'Start' : 'Restart';
      ref.startBtn.disabled = (t.state === 'running');
      ref.pauseBtn.innerHTML = t.state === 'paused'
        ? '<i class="fa-solid fa-play"></i>'
        : '<i class="fa-solid fa-pause"></i>';
      ref.pauseBtn.title = t.state === 'paused' ? 'Resume' : 'Pause';
      ref.pauseBtn.disabled = (t.state!=='running' && t.state!=='paused');
      ref.stopBtn.disabled = (t.state === 'stopped');
      ref.dot.className = 'timer-status-dot dot-' + t.state;
      ref.status.innerHTML = `${ref.dot.outerHTML}<strong>Status:</strong> ${t.state[0].toUpperCase()+t.state.slice(1)}`;
      ref.start.textContent = t.startTime ? new Date(t.startTime).toLocaleTimeString() : '--:--:--';
      ref.elapsed.textContent = formatDuration(t.elapsed);
      ref.nameSpan.textContent = t.name;
      if (ref.dateInput) ref.dateInput.value = t.date;
      if (ref.timeInput) ref.timeInput.value = t.time;
    }

    function updateElapsedTimes() {
      timers.forEach(timer => {
        if (timer.state === 'running') {
          timer.elapsed = Date.now() - timer.startTime;
        }
        const ref = timerRefs[timer.id];
        if (ref && ref.elapsed) {
          ref.elapsed.textContent = formatDuration(timer.elapsed);
        }
      });
    }

    renderTimers();
    setInterval(updateElapsedTimes, 1000);
  </script>
</body>
</html>